<!--
 Copyright 2006-2012 The Scriptella Project Team.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->
<!DOCTYPE etl SYSTEM "http://scriptella.javaforge.com/dtd/etl.dtd">
<etl>
    <description>
        This example produces a HTML report
        based on the Categories table from the Northwind.mdb
    </description>
    <!-- ODBC Connection to Northwind Microsoft Access Database.
     Use the same driver name and URL syntax for other ODBC sources.-->
    <connection id="odbc" url="jdbc:odbc:DRIVER={Microsoft Access Driver (*.mdb)};DBQ=Northwind.mdb"/>
    <!-- Java code -->
    <connection id="java" driver="janino" classpath="../lib/janino.jar"/>
    <!-- HTML report outputted by Text driver to categories.html -->
    <connection id="text" driver="text" url="categories.html"/>
    <script connection-id="java">
        new java.io.File("img").mkdir(); //creating a directory for images
    </script>
    <script connection-id="text"><!--Writing HTML report header-->
        <![CDATA[
        <html>
            <head>
                <title>Northwind Database Categories</title>
            </head>
            <body>
               <table border=1>
                 <tr><th>Category ID</th><th>Category Name</th><th>Description</th><th>Picture</th></tr>
        ]]>
    </script>

    <query connection-id="odbc"><!--Select all categories-->
        <!-- Description is of Memo(LongVarchar) type, so we have to convert it to a simple
             String using TRIM() function, otherwise Scriptella obtains the field as CLOB.
             CLOBS are safe for large Strings, but they are more difficult to use in Velocity-->
        SELECT CategoryID, CategoryName, TRIM(Description) as descr, Picture FROM Categories;
        <!--For each row produce <TR> in the html file. Use $column_name to reference columns.
        The last Picture column is written as a href to a file in an img directory-->
        <script connection-id="text"><![CDATA[
        <tr>
            <td>$categoryid</td><td>$categoryname</td><td>$descr</td><td><img src="img/${rownum}.bmp"></td>
        </tr>]]>
        </script>
        <!--Write content of the Picture column to a file named rownum.bmp
        where rownum is the current row number-->
        <script connection-id="java">
            import java.io.*;
            import java.sql.Blob;
            OutputStream os = new FileOutputStream("img/"+get("rownum")+".bmp");
            Blob blob = (Blob)get("picture"); //Get Picture column BLOB for the current row
            byte[] b = scriptella.util.IOUtils.toByteArray(blob.getBinaryStream()); //Convert BLOB to bytes
            //Write the picture bytes to a file named $rownum.bmp
            os.write(b, 78, b.length-79); //A hack to make BMP from Paintbrush OLE object
            os.close(); //Closing the stream
        </script>
    </query>
    <!--Writing the footer-->
    <script connection-id="text">
        <![CDATA[
            </table>
            <table>
                <tr valign="center">
                    <td><a href="http://scriptella.javaforge.com"><img border=0 src="../primes/scriptella-powered.gif" alt="Powered by Scriptella"></a></td>
                    <td><font face="Arial">Generated by <font size="+1"><b>scriptella</b></font> ETL.</font></td>
                </tr>
            </table>
            </body>
            </html>
        ]]>
    </script>

</etl>